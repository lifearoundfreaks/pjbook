{% extends 'layout/base.html' %}
{% load form_tags %}
{% load static %}

{% block content %} 
  
<div class="container-fluid">
  <div class="row flex-xl-nowrap">
  <div class="col-12 col-md-3 col-xl-2 bd-sidebar">
    <nav id="bd-docs-nav" class="collapse bd-links">
        <ul class="section-nav_room">
            <li class="toc-entry toc-h2"> 
                <button type="button" class="btn btn-light" onclick="rooms('all')">All rooms</a>
            </li>
                <li class="toc-entry toc-h2">
                <button type="button" class="btn btn-light" onclick="rooms('myroom')">My room</a>
            </li> 
            <li>
            <a href="{% url 'create' %}" title="create room"><svg class="bi bi-plus" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M8 3.5a.5.5 0 01.5.5v4a.5.5 0 01-.5.5H4a.5.5 0 010-1h3.5V4a.5.5 0 01.5-.5z" clip-rule="evenodd"/>
                <path fill-rule="evenodd" d="M7.5 8a.5.5 0 01.5-.5h4a.5.5 0 010 1H8.5V12a.5.5 0 01-1 0V8z" clip-rule="evenodd"/>
            </svg></a>
            </li>
            </ul> 
    {% for item in rooms %}
    <div class="bd-toc-item">
        <a class="bd-toc-link" href="{% url 'detail' pk=item.id %}">{{item.name}}</a>
        {% comment %} <small class="bd-toc-link">({% count_msg item.id id_user %})</small> {% endcomment %}
        <small class="bd-toc-link">created  {{item.author}}</small>
        <small class="bd-toc-link">date  {{item.created_date}}</small>
        {% if id_user == item.author.id|stringformat:"i" %} 
            <a class="bd-toc-link" href="{% url 'delete' pk=item.id %}" title="delete room">
            Delete
            </a> 
        {% endif %}
        </div> 
    {% endfor %}

    </nav>

</div> 
  <!--menu content room-->    
    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content" role="main">
       <ul class="section-nav_msg">
        <li class="toc-entry"> 
         <h1 class="bd-title" id="content">{{ object.name }}</h1> 
         </li>
         <li class="toc-entry">   
            {% if not is_member %}
                <button type="button" class="btn btn-light" onclick="join('{{object.pk}}')">Вступить</button>
            {% endif %}
        </li>
        </ul>

      <div class="bd-messeges" id="wrapp">
        <div class="bd-message" data-spy="scroll"  data-offset="1">  
        {% if is_member %} 
          {% for item in messages %} 
             {% comment %} {% read_msg item.id %}  {% endcomment %}
              <div class="message">
                   <div class="author_mes">{{item.user}}</div> 
                  <div class="content-mes">
                    {{item.text}}
                  </div>  
                  <div class="time"> {{item.created_date|date:"Y-m-d H:i:s"}}</div>
              </div>   
          {% endfor %} 
        {% endif %}
        </div> 
          
      </div> 
      {% if is_member %}
      <div class="send">
            <textarea class="form-control" id="text"></textarea>
            <div class="input-group-append">
                <button type="button" id="chat-message-submit" class="btn btn-primary">Send</button>
            </div>
        </div>  
        {% endif %}
    </main>
    
    {% block menu_profile %}
      {% include 'layout/menu_profile.html' %}
	  {% endblock %}  

    </div>
  </div> 
</div> 
<script src="{% static 'js/reconnecting-websocket.js' %}"> </script>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
    var wrapp = document.getElementById('wrapp'); 
     wrapp.scrollTop = wrapp.scrollHeight;
 })
 var roomName = "{{ object.slug }}"; 
 var id_user =  "{{ id_user }}"; 
 var chatSocket = new ReconnectingWebSocket(
     'ws://' + window.location.host +
     '/ws/chat/' + roomName + '/'); 
 chatSocket.onmessage = function(e) {
     var data = JSON.parse(e.data);
     
     var message = data['message']; 
     var author = message.author;
     var time = message.timestamp; 
     var mes = document.querySelector('.bd-message')
     var messageDiv = document.createElement('div')
     messageDiv.className = "message"; 
     mes.appendChild(messageDiv);

     var mes_time = document.createElement('div')
     mes_time.className = "time";
     mes_time.innerHTML = time
     messageDiv.appendChild(mes_time);
     
     var contentDiv = document.createElement('div')
     contentDiv.className = "content-mes";
     contentDiv.innerHTML = message.content;
     messageDiv.appendChild(contentDiv);

     var authorDiv = document.createElement('div')
     authorDiv.className = "author_mes";
     authorDiv.innerHTML = author
     messageDiv.appendChild(authorDiv);

     var wrapp = document.getElementById('wrapp'); 
     wrapp.scrollTop = wrapp.scrollHeight;
      
 };

 chatSocket.onclose = function(e) {
     console.error('Chat socket closed unexpectedly');
 };

 document.querySelector('#text').focus();
 document.querySelector('#text').onkeyup = function(e) {
     if (e.keyCode === 13) {  // enter, return
         document.querySelector('#chat-message-submit').click();
     }
 };

 document.querySelector('#chat-message-submit').onclick = function(e) {
     var messageInputDom = document.querySelector('#text'); 
     var message = messageInputDom.value;
     chatSocket.send(JSON.stringify({
         'message': message,
         'command': 'new_message',
         'from': id_user
     }));

     messageInputDom.value = '';
 };
</script>

{% endblock %}  